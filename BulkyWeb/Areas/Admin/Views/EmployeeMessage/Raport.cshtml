@{
    ViewData["Title"] = "Messages from Employees";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mt-4 mb-4">Messages from Employees</h2>

<table class="table table-bordered table-striped" id="messageTable">
    <thead class="table-dark">
        <tr>
            <th>Employee Name</th>
            <th>Message</th>
            <th>Date</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Messages will be filled by JavaScript -->
    </tbody>
</table>

@section Scripts {
    <script>
        async function loadMessages() {
            try {
                const response = await fetch('/api/EmployeeMessage/GetAll');
                const data = await response.json();

                const tbody = document.querySelector('#messageTable tbody');
                tbody.innerHTML = "";

                data.forEach(msg => {
                    const row = `<tr>
                        <td>${msg.userName}</td>
                        <td>${msg.messageText}</td>
                        <td>${new Date(msg.createdAt).toLocaleString()}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="toggleChecked(this)">CHECK</button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMessage('${msg.id}')">DELETE</button>
                        </td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            } catch (err) {
                console.error("Error fetching messages:", err);
            }
        }

        function toggleChecked(button) {
            // If the button is already in "checked" state, uncheck it
            if (button.classList.contains("btn-outline-success")) {
                button.classList.remove("btn-outline-success");
                button.classList.add("btn-success");
                button.textContent = "CHECK"; // Reset the button text to "CHECK"
            } else {
                // If the button is not checked, mark it as "checked"
                button.classList.remove("btn-success");
                button.classList.add("btn-outline-success");
                button.textContent = "CHECKED"; // Change text to "CHECKED"
            }
        }

        async function deleteMessage(id) {
            if (!id) {
                alert("Message ID is missing!");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to delete this message?");
            if (!confirmDelete) return;

            try {
                const response = await fetch(`/api/EmployeeMessage/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert("Message deleted successfully!");
                    loadMessages();
                } else {
                    alert("Delete failed.");
                }
            } catch (err) {
                alert("Error deleting message.");
                console.error(err);
            }
        }

        document.addEventListener("DOMContentLoaded", loadMessages);
    </script>
}
